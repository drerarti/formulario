<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plano Din√°mico</title>

<style>
body { font-family: Arial; margin:0; }

#header {
  padding:10px;
  background:#111;
  color:white;
  font-size:14px;
}

#plano-wrapper {
  width: 100%;
   height: calc(100vh - 180px);
  overflow: hidden;
  touch-action: none;
  background: #e9ecef;
}

#plano-container svg {
  width: 100%;
  height: 100%;
}

path {
  transition: fill 0.3s ease;
  cursor: pointer;
}

path.selected {
  stroke: #000;
  stroke-width: 2;
}

#tooltip {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  padding: 8px 12px;
  font-size: 13px;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  pointer-events: none;
  display: none;
  z-index: 1000;
}

#mobile-card {
  position: fixed;
  bottom: 0;
  left: 0;

  width: 100%;
  box-sizing: border-box; /* üî• CLAVE */

  max-height: 45vh;
  overflow-y: auto;

  background: white;
  padding: 14px 16px 18px 16px;

  box-shadow: 0 -6px 25px rgba(0,0,0,0.18);
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;

  transition: transform 0.45s cubic-bezier(0.16, 1, 0.3, 1);
  transform: translateY(100%);
  z-index: 9999;
}
#mobile-card h3 {
  margin: 0 0 8px 0;
  font-size: 18px;
}

#mobile-card p {
  margin: 4px 0;
  font-size: 14px;
}
#mobile-card.active {
  transform: translateY(0);
}

.close-card {
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: 18px;
  cursor: pointer;
}
#filtros {
  padding:10px;
  background:#f0f0f0;
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  font-size:14px;
}
#selector-proyecto {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #222;
}

#selector-proyecto select {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
  font-size: 14px;
}
#resumen {
  padding: 8px 10px;
  background: #111;
  color: white;
  font-size: 13px;
  display: flex;
  justify-content: space-around;
}
.btn-reservar {
  width: 100%;
  margin-top: 12px;
  padding: 12px;
  background: linear-gradient(135deg,#28a745,#218838);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  
}
.blur-bg {
  filter: blur(1px) brightness(0.9);
  transition: filter 0.3s ease;
}
#top-panel {
  position: relative;
  z-index: 2000;
}

#top-bar {
  display: none;
  background: #111;
  color: white;
  padding: 10px 14px;
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#toggle-panel {
  cursor: pointer;
  font-size: 16px;
}

#top-content {
  transition: max-height 0.35s ease, opacity 0.3s ease;
}

/* üì± SOLO EN M√ìVIL */
@media (max-width: 768px) {

  #top-bar {
    display: flex;
  }

  #top-content {
    overflow: hidden;
    max-height: 0;
    opacity: 0;
  }

  #top-content.active {
    max-height: 600px;
    opacity: 1;
  }

}
.modal-360 {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 9999;
  display: flex;
  flex-direction: column;
}

.modal-360.hidden {
  display: none;
}

.modal-header {
  color: white;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  font-size: 14px;
}

#visor360 {
  flex: 1;
}
#btnPresentacion {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg,#000,#1c1c1c);
  color: white;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 10px;
  transition: all 0.25s ease;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  letter-spacing: 0.5px;
}

#btnPresentacion:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 24px rgba(0,0,0,0.45);
}
body.no-scroll { overflow: hidden; }
</style>
</head>

<body>


<div id="top-panel">

  <div id="top-bar">
    <span id="mini-info"></span>
    <span id="toggle-panel">‚ñº</span>
  </div>
  <div id="top-content">
    <div id="header"></div>
    <button id="btnPresentacion">Modo Presentaci√≥n</button>
<div id="selector-proyecto">
  <select id="selectProyecto">
    <option value="ALP">ALP</option>
    <option value="SOL">SOL</option>
    <option value="TER">TER</option>
  </select>

  <select id="selectFase">
    <option value="F1">F1</option>
    <option value="F2">F2</option>
    <option value="E1">E1</option>
    <option value="T1">T1</option>
  </select>
  <button onclick="logout()" style="margin-left:10px;">Salir</button>
</div>
<div id="resumen"></div>
<div id="filtros">
  <label><input type="checkbox" value="disponible" checked> Disponible</label>
  <label><input type="checkbox" value="reservado" checked> Reservado</label>
  <label><input type="checkbox" value="vendido" checked> Vendido</label>
  <label><input type="checkbox" value="financiado" checked> Financiado</label>
</div>
</div>
</div>
<div id="plano-wrapper">
  <div id="plano-container"></div>
</div>

<div id="tooltip"></div>

<div id="mobile-card"></div>

<script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>
<div id="modal360" class="modal-360 hidden">
  <div class="modal-header">
    <span id="contador360">Vista 1 de 1</span>
    <button id="cerrar360">Cerrar</button>
  </div>

  <div id="visor360"></div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<script>
  
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
let mapaLotes = {};

// üî∑ Leer par√°metros de URL
const params = new URLSearchParams(window.location.search);
const proyecto = params.get("proyecto");
const fase = params.get("fase");
const claveProyecto = `${proyecto.toLowerCase()}-${fase.toLowerCase()}`;
const vistas360Config = {
  "alp-f2": 1
};
// ===============================
// PROTECCI√ìN DE ACCESO
// ===============================

const agenteCodigo = localStorage.getItem("agente_codigo");

if (!agenteCodigo) {
  window.location.href = "/login-agente.html";
}
if (!proyecto || !fase) {
  document.getElementById("header").innerText = "Faltan par√°metros proyecto y fase";
  throw new Error("Proyecto o fase no definidos");
}
document.getElementById("selectProyecto").value = proyecto;
document.getElementById("selectFase").value = fase;
// Mostrar en header
document.getElementById("header").innerText = `Proyecto: ${proyecto} | Fase: ${fase}`;
const agenteNombre = localStorage.getItem("agente_nombre");

if (agenteNombre) {
  document.getElementById("header").innerHTML += 
    " | Agente: " + agenteNombre;
}

// Mini info compacta
function actualizarMiniInfo() {
  const resumenTexto = document.getElementById("resumen").innerText;
  document.getElementById("mini-info").innerText =
    `${proyecto} | ${fase}`;
}

actualizarMiniInfo();

// Toggle panel m√≥vil
const toggleBtn = document.getElementById("toggle-panel");
const topContent = document.getElementById("top-content");

toggleBtn.addEventListener("click", () => {
  topContent.classList.toggle("active");

  toggleBtn.innerText =
    topContent.classList.contains("active") ? "‚ñ≤" : "‚ñº";
});
// üî∑ Cargar SVG din√°mico seg√∫n nombre
const nombreSVG = `${proyecto.toLowerCase()}-${fase.toLowerCase()}-ma.svg`;

fetch(`/planos/${nombreSVG}`)
  .then(res => {
    if (!res.ok) throw new Error("SVG no encontrado");
    return res.text();
  })
  .then(svg => {

    document.getElementById("plano-container").innerHTML = svg;

    const element = document.querySelector('#plano-container svg');

    const panzoom = Panzoom(element, {
  maxScale: 4,
  minScale: 1,
  step: 0.30,
  contain: 'outside',
  animate: true,
  duration: 120
});

    element.parentElement.addEventListener('wheel', panzoom.zoomWithWheel);

    cargarEstados();
  });

// üî∑ Cargar estados din√°micamente
function cargarEstados() {

  const colores = {
    disponible: "#28a745",
    reservado: "#ffc107",
    vendido: "#dc3545",
    financiado: "#0d6efd"
  };

  fetch(`/.netlify/functions/airtable?plano=1&proyecto=${proyecto}&fase=${fase}`)
    .then(res => res.json())
    .then(data => {

      mapaLotes = {};

      data.forEach(lote => {
        mapaLotes[lote.lote_id] = lote;

        const el = document.getElementById(lote.lote_id);
        if (!el) return;

        el.style.fill = colores[lote.estado] || "#cccccc";
      });

      activarEventos();
      aplicarFiltro();
      actualizarResumen(data);
      actualizarMiniInfo();
    });
}
function getColorEstado(estado) {
  return {
    disponible: "#28a745",
    reservado: "#ffc107",
    vendido: "#dc3545",
    financiado: "#0d6efd"
  }[estado] || "#999";
}
const btnPresentacion = document.getElementById("btnPresentacion");
const modal360 = document.getElementById("modal360");
const cerrar360 = document.getElementById("cerrar360");

if (btnPresentacion && modal360 && cerrar360) {

  btnPresentacion.addEventListener("click", () => {
    modal360.classList.remove("hidden");
    document.body.classList.add("no-scroll");
    vistaActual = 1;
    iniciarVisor360();
  });

  cerrar360.addEventListener("click", () => {
    modal360.classList.add("hidden");
    document.body.classList.remove("no-scroll");
    if (viewer) viewer.destroy();
  });

}
function activarEventos() {

  const svg = document.querySelector('#plano-container svg');
  const tooltip = document.getElementById("tooltip");

  svg.addEventListener("click", (e) => {

    const target = e.target.closest("path");
    if (!target) return;

    const lote = mapaLotes[target.id];
    if (!lote) return;
if (target.classList.contains("bloqueado")) return;
    document.querySelectorAll("path").forEach(p => p.classList.remove("selected"));
    target.classList.add("selected");
    target.style.filter = "brightness(1.1)";

    const mobileCard = document.getElementById("mobile-card");

    let botonAccion = "";

if (lote.estado === "disponible") {
  botonAccion = `
    <button class="btn-reservar"
      onclick="irAReserva('${lote.lote_id}')">
      Reservar ahora
    </button>
  `;
}

mobileCard.innerHTML = `
<div style="width:40px;height:4px;background:#ccc;border-radius:4px;margin:0 auto 12px;"></div>

<span class="close-card" onclick="cerrarCard()">‚úï</span>

<div style="
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
  flex-wrap:nowrap;
">

  <h3 style="
    margin:0;
    font-size:16px;
    flex:1;
    min-width:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  ">
    ${lote.lote_id}
  </h3>

  <span style="
    padding:4px 8px;
    border-radius:20px;
    font-size:11px;
    font-weight:bold;
    background:${getColorEstado(lote.estado)};
    color:white;
    flex-shrink:0;
    white-space:nowrap;
  ">
    ${lote.estado.toUpperCase()}
  </span>

</div>

<div style="
  background:#f7f7f7;
  padding:10px;
  border-radius:12px;
  margin-bottom:10px;
">
  <p style="margin:4px 0;"><strong>Precio:</strong> S/ ${lote.precio.toLocaleString()}</p>
  <p style="margin:4px 0;"><strong>√Årea:</strong> ${lote.area} m¬≤</p>
</div>

${botonAccion}
`;

    mobileCard.classList.add("active");
    document.getElementById("plano-wrapper").classList.add("blur-bg");
    document.body.classList.add("no-scroll");

    setTimeout(() => {
      document.addEventListener("click", cerrarSiFuera);
    }, 100);
  });

  if (!isTouchDevice) {
    svg.addEventListener("mousemove", (e) => {

      const target = e.target.closest("path");
      if (!target) {
        tooltip.style.display = "none";
        return;
      }

      const lote = mapaLotes[target.id];
      if (!lote) return;
if (target.classList.contains("bloqueado")) {
  tooltip.style.display = "none";
  return;
}
      tooltip.style.display = "block";
      tooltip.innerHTML = `
        <strong>${lote.lote_id}</strong><br>
        Estado: ${lote.estado}<br>
        Precio: S/ ${lote.precio.toLocaleString()}
        <p><strong>√Årea:</strong> ${lote.area} m¬≤</p>
      `;

      tooltip.style.left = e.pageX + 15 + "px";
      tooltip.style.top = e.pageY + 15 + "px";
    });

    svg.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });
  }
}
function aplicarFiltro() {

  const activos = Array.from(
    document.querySelectorAll('#filtros input:checked')
  ).map(i => i.value);

  Object.values(mapaLotes).forEach(lote => {

    const el = document.getElementById(lote.lote_id);
    if (!el) return;

    if (activos.includes(lote.estado)) {
      el.style.opacity = "1";
      el.classList.remove("bloqueado");
    } else {
      el.style.opacity = "0.15";
      el.classList.add("bloqueado");
    }

  });
}

function cerrarCard() {
  document.getElementById("mobile-card").classList.remove("active");
  document.body.classList.remove("no-scroll");
  document.getElementById("plano-wrapper").classList.remove("blur-bg");
  document.querySelectorAll("path").forEach(p => p.classList.remove("selected"));
  document.querySelectorAll("path").forEach(p => {
  p.classList.remove("selected");
  p.style.filter = "none";
});
}

function cerrarSiFuera(e) {
  const card = document.getElementById("mobile-card");
  if (!card.contains(e.target)) {
    cerrarCard();
    document.removeEventListener("click", cerrarSiFuera);
  }
}
document.querySelectorAll('#filtros input')
  .forEach(input => {
    input.addEventListener('change', aplicarFiltro);
  });
  document.getElementById("selectProyecto")
  .addEventListener("change", actualizarPlano);

document.getElementById("selectFase")
  .addEventListener("change", actualizarPlano);

function actualizarPlano() {
  const nuevoProyecto = document.getElementById("selectProyecto").value;
  const nuevaFase = document.getElementById("selectFase").value;

  window.location.href =
    `plano-test.html?proyecto=${nuevoProyecto}&fase=${nuevaFase}`;
}
function actualizarResumen(data) {

  const conteo = {
    disponible: 0,
    reservado: 0,
    vendido: 0,
    financiado: 0
  };

  data.forEach(lote => {
    if (conteo[lote.estado] !== undefined) {
      conteo[lote.estado]++;
    }
  });

  document.getElementById("resumen").innerHTML = `
    Disponibles: ${conteo.disponible} |
    Reservados: ${conteo.reservado} |
    Vendidos: ${conteo.vendido} |
    Financiados: ${conteo.financiado}
  `;
}
function irAReserva(unidadId) {
  window.location.href = `/index.html?unidad_id=${unidadId}`;
}
function logout() {
  localStorage.removeItem("agente_codigo");
  localStorage.removeItem("agente_nombre");
  window.location.href = "/login-agente.html";
}
let viewer = null;
let vistaActual = 1;

function iniciarVisor360() {

  const totalVistas = vistas360Config[claveProyecto] || 1;
  const ruta = `/assets/360/${claveProyecto}/0${vistaActual}.jpg`;

  if (viewer) {
    viewer.destroy();
  }

  viewer = pannellum.viewer('visor360', {
    type: 'equirectangular',
    panorama: ruta,
    autoLoad: true,
    showZoomCtrl: true,
    showFullscreenCtrl: false,
    compass: false
  });

  document.getElementById("contador360").innerText =
    `Vista ${vistaActual} de ${totalVistas}`;
}
</script>
</body>
</html>