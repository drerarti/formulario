<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plano DinÃ¡mico</title>

<style>
body { font-family: Arial; margin:0; }

#header {
  padding:10px;
  background:#111;
  color:white;
  font-size:14px;
}

#plano-wrapper {
  width: 100%;
  height: calc(100vh - 180px);
  overflow: hidden;
  touch-action: none;
  background: #f5f5f5;
}

#plano-container svg {
  width: 100%;
  height: 100%;
}

path {
  transition: fill 0.3s ease;
  cursor: pointer;
}

path.selected {
  stroke: #000;
  stroke-width: 2;
}

#tooltip {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  padding: 8px 12px;
  font-size: 13px;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  pointer-events: none;
  display: none;
  z-index: 1000;
}

#mobile-card {
  position: fixed;
  bottom: -300px;
  left: 0;
  width: 100%;
  max-height: 60vh;
  overflow-y: auto;
  background: white;
  padding: 16px;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  transition: bottom 0.3s ease;
  z-index: 2000;
}

#mobile-card.active { bottom: 0; }

.close-card {
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: 18px;
  cursor: pointer;
}
#filtros {
  padding:10px;
  background:#f0f0f0;
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  font-size:14px;
}
#selector-proyecto {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #222;
}

#selector-proyecto select {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
  font-size: 14px;
}
#resumen {
  padding: 8px 10px;
  background: #111;
  color: white;
  font-size: 13px;
  display: flex;
  justify-content: space-around;
}
.btn-reservar {
  width: 100%;
  margin-top: 15px;
  padding: 12px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: bold;
}
body.no-scroll { overflow: hidden; }
</style>
</head>

<body>

<div id="header"></div>
<div id="selector-proyecto">
  <select id="selectProyecto">
    <option value="ALP">ALP</option>
    <option value="SOL">SOL</option>
    <option value="TER">TER</option>
  </select>

  <select id="selectFase">
    <option value="F1">F1</option>
    <option value="F2">F2</option>
    <option value="E1">E1</option>
    <option value="T1">T1</option>
  </select>
  <button onclick="logout()" style="margin-left:10px;">Salir</button>
</div>
<div id="resumen"></div>
<div id="filtros">
  <label><input type="checkbox" value="disponible" checked> Disponible</label>
  <label><input type="checkbox" value="reservado" checked> Reservado</label>
  <label><input type="checkbox" value="vendido" checked> Vendido</label>
  <label><input type="checkbox" value="financiado" checked> Financiado</label>
</div>
<div id="plano-wrapper">
  <div id="plano-container"></div>
</div>

<div id="tooltip"></div>
<div id="mobile-card"></div>

<script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>

<script>
  
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
let mapaLotes = {};

// ðŸ”· Leer parÃ¡metros de URL
const params = new URLSearchParams(window.location.search);
const proyecto = params.get("proyecto");
const fase = params.get("fase");

// ===============================
// PROTECCIÃ“N DE ACCESO
// ===============================

const agenteCodigo = localStorage.getItem("agente_codigo");

if (!agenteCodigo) {
  window.location.href = "/login-agente.html";
}
if (!proyecto || !fase) {
  document.getElementById("header").innerText = "Faltan parÃ¡metros proyecto y fase";
  throw new Error("Proyecto o fase no definidos");
}
document.getElementById("selectProyecto").value = proyecto;
document.getElementById("selectFase").value = fase;
// Mostrar en header
document.getElementById("header").innerText = `Proyecto: ${proyecto} | Fase: ${fase}`;
const agenteNombre = localStorage.getItem("agente_nombre");

if (agenteNombre) {
  document.getElementById("header").innerHTML += 
    " | Agente: " + agenteNombre;
}
// ðŸ”· Cargar SVG dinÃ¡mico segÃºn nombre
const nombreSVG = `${proyecto.toLowerCase()}-${fase.toLowerCase()}-ma.svg`;

fetch(`/planos/${nombreSVG}`)
  .then(res => {
    if (!res.ok) throw new Error("SVG no encontrado");
    return res.text();
  })
  .then(svg => {

    document.getElementById("plano-container").innerHTML = svg;

    const element = document.querySelector('#plano-container svg');

    const panzoom = Panzoom(element, {
  maxScale: 4,
  minScale: 1,
  step: 0.08,
  contain: 'outside',
  animate: true,
  duration: 180
});

    element.parentElement.addEventListener('wheel', panzoom.zoomWithWheel);

    cargarEstados();
  });

// ðŸ”· Cargar estados dinÃ¡micamente
function cargarEstados() {

  const colores = {
    disponible: "#28a745",
    reservado: "#ffc107",
    vendido: "#dc3545",
    financiado: "#0d6efd"
  };

  fetch(`/.netlify/functions/airtable?plano=1&proyecto=${proyecto}&fase=${fase}`)
    .then(res => res.json())
    .then(data => {

      mapaLotes = {};

      data.forEach(lote => {
        mapaLotes[lote.lote_id] = lote;

        const el = document.getElementById(lote.lote_id);
        if (!el) return;

        el.style.fill = colores[lote.estado] || "#cccccc";
      });

      activarEventos();
      aplicarFiltro();
      actualizarResumen(data);
    });
}

function activarEventos() {

  const svg = document.querySelector('#plano-container svg');
  const tooltip = document.getElementById("tooltip");

  svg.addEventListener("click", (e) => {

    const target = e.target.closest("path");
    if (!target) return;

    const lote = mapaLotes[target.id];
    if (!lote) return;
if (target.classList.contains("bloqueado")) return;
    document.querySelectorAll("path").forEach(p => p.classList.remove("selected"));
    target.classList.add("selected");

    const mobileCard = document.getElementById("mobile-card");

    let botonAccion = "";

if (lote.estado === "disponible") {
  botonAccion = `
    <button class="btn-reservar"
      onclick="irAReserva('${lote.lote_id}')">
      Reservar ahora
    </button>
  `;
}

mobileCard.innerHTML = `
  <span class="close-card" onclick="cerrarCard()">âœ•</span>
  <h3>${lote.lote_id}</h3>
  <p><strong>Estado:</strong> ${lote.estado}</p>
  <p><strong>Precio:</strong> S/ ${lote.precio.toLocaleString()}</p>
  <p><strong>Manzana:</strong> ${lote.manzana}</p>
  <p><strong>Lote:</strong> ${lote.lote}</p>
  ${botonAccion}
`;

    mobileCard.classList.add("active");
    document.body.classList.add("no-scroll");

    setTimeout(() => {
      document.addEventListener("click", cerrarSiFuera);
    }, 100);
  });

  if (!isTouchDevice) {
    svg.addEventListener("mousemove", (e) => {

      const target = e.target.closest("path");
      if (!target) {
        tooltip.style.display = "none";
        return;
      }

      const lote = mapaLotes[target.id];
      if (!lote) return;
if (target.classList.contains("bloqueado")) {
  tooltip.style.display = "none";
  return;
}
      tooltip.style.display = "block";
      tooltip.innerHTML = `
        <strong>${lote.lote_id}</strong><br>
        Estado: ${lote.estado}<br>
        Precio: S/ ${lote.precio.toLocaleString()}
      `;

      tooltip.style.left = e.pageX + 15 + "px";
      tooltip.style.top = e.pageY + 15 + "px";
    });

    svg.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });
  }
}
function aplicarFiltro() {

  const activos = Array.from(
    document.querySelectorAll('#filtros input:checked')
  ).map(i => i.value);

  Object.values(mapaLotes).forEach(lote => {

    const el = document.getElementById(lote.lote_id);
    if (!el) return;

    if (activos.includes(lote.estado)) {
      el.style.opacity = "1";
      el.classList.remove("bloqueado");
    } else {
      el.style.opacity = "0.15";
      el.classList.add("bloqueado");
    }

  });
}

function cerrarCard() {
  document.getElementById("mobile-card").classList.remove("active");
  document.body.classList.remove("no-scroll");
  document.querySelectorAll("path").forEach(p => p.classList.remove("selected"));
}

function cerrarSiFuera(e) {
  const card = document.getElementById("mobile-card");
  if (!card.contains(e.target)) {
    cerrarCard();
    document.removeEventListener("click", cerrarSiFuera);
  }
}
document.querySelectorAll('#filtros input')
  .forEach(input => {
    input.addEventListener('change', aplicarFiltro);
  });
  document.getElementById("selectProyecto")
  .addEventListener("change", actualizarPlano);

document.getElementById("selectFase")
  .addEventListener("change", actualizarPlano);

function actualizarPlano() {
  const nuevoProyecto = document.getElementById("selectProyecto").value;
  const nuevaFase = document.getElementById("selectFase").value;

  window.location.href =
    `plano-test.html?proyecto=${nuevoProyecto}&fase=${nuevaFase}`;
}
function actualizarResumen(data) {

  const conteo = {
    disponible: 0,
    reservado: 0,
    vendido: 0,
    financiado: 0
  };

  data.forEach(lote => {
    if (conteo[lote.estado] !== undefined) {
      conteo[lote.estado]++;
    }
  });

  document.getElementById("resumen").innerHTML = `
    Disponibles: ${conteo.disponible} |
    Reservados: ${conteo.reservado} |
    Vendidos: ${conteo.vendido} |
    Financiados: ${conteo.financiado}
  `;
}
function irAReserva(unidadId) {
  window.location.href = `/index.html?unidad_id=${unidadId}`;
}
function logout() {
  localStorage.removeItem("agente_codigo");
  localStorage.removeItem("agente_nombre");
  window.location.href = "/login-agente.html";
}
</script>

</body>
</html>